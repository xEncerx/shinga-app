name: ğŸš€ Flutter CI/CD with Shorebird

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, dev, feature/* ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.6'
  JAVA_VERSION: '17'

jobs:
  # ========================================
  # ğŸ§ª Testing (for all branches)
  # ========================================
  test:
    name: ğŸ§ª Run Tests & Analysis
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            **/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: ğŸ“š Get Flutter dependencies
        run: flutter pub get

      - name: ğŸ”§ Run code generation
        run: |
          dart run slang
          dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ•µï¸ Static code analysis
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: âœ… Run unit tests
        run: flutter test --coverage

  # ========================================
  # ğŸ—ï¸ Build & Release (only for main)
  # ========================================
  build:
    name: ğŸ—ï¸ Build & Release
    needs: test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Enable Git Long Paths
        run: git config --system core.longpaths true
        shell: pwsh

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ¦ Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1

      - name: ğŸ” Authenticate Shorebird
        run: |
          shorebird doctor
          if (-not (Test-Path "shorebird.yaml")) {
            Write-Error "shorebird.yaml not found! Initialize Shorebird locally first."
            exit 1
          }
        shell: pwsh
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            **/.dart_tool
            **/build
          key: ${{ runner.os }}-build-${{ hashFiles('**/pubspec.lock', '**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: ğŸ“š Get dependencies
        run: flutter pub get

      - name: ğŸ”§ Run code generation
        run: |
          dart run slang
          dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ”‘ Decode Keystore
        run: |
          $base64String = "${{ secrets.KEYSTORE_BASE64 }}".Replace("`n","").Replace("`r","")
          $bytes = [System.Convert]::FromBase64String($base64String)
          $keystorePath = Join-Path $env:GITHUB_WORKSPACE "android/app/keystore.jks"
          [System.IO.File]::WriteAllBytes($keystorePath, $bytes)
          Write-Host "âœ… Keystore created at: $keystorePath"
        shell: pwsh

      - name: ğŸ“ Create key.properties
        run: |
          @"
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=keystore.jks
          "@ | Out-File -FilePath android/key.properties -Encoding utf8
          Write-Host "âœ… key.properties created"
        shell: pwsh

      # ========================================
      # ğŸ¤– Android Build with Shorebird
      # ========================================
      - name: ğŸ¤– Build Android Release with Shorebird
        run: |
          shorebird release android `
            --flutter-version=${{ env.FLUTTER_VERSION }} `
            --artifact apk `
            -- `
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} `
            --dart-define=GOOGLE_CLIENT_ANDROID_ID=${{ secrets.GOOGLE_CLIENT_ANDROID_ID }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_SECRET=${{ secrets.GOOGLE_CLIENT_WINDOWS_SECRET }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_ID=${{ secrets.GOOGLE_CLIENT_WINDOWS_ID }} `
            --dart-define=YANDEX_CLIENT_ID=${{ secrets.YANDEX_CLIENT_ID }}
        shell: pwsh
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: ğŸ“¦ Copy Android artifacts
        run: |
          $apkFiles = Get-ChildItem -Path build/app/outputs/apk/release/*.apk -ErrorAction SilentlyContinue
          if (-not $apkFiles) {
            Write-Error "âŒ No APK files found!"
            exit 1
          }
          foreach ($file in $apkFiles) {
            $newName = "app-" + $file.Name
            Copy-Item $file.FullName -Destination $newName
            Write-Host "âœ… Created: $newName"
          }
        shell: pwsh

      # ========================================
      # ğŸªŸ Windows Build with Shorebird
      # ========================================
      - name: ğŸªŸ Build Windows Release with Shorebird
        run: |
          shorebird release windows `
            --flutter-version=${{ env.FLUTTER_VERSION }} `
            -- `
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} `
            --dart-define=GOOGLE_CLIENT_ANDROID_ID=${{ secrets.GOOGLE_CLIENT_ANDROID_ID }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_SECRET=${{ secrets.GOOGLE_CLIENT_WINDOWS_SECRET }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_ID=${{ secrets.GOOGLE_CLIENT_WINDOWS_ID }} `
            --dart-define=YANDEX_CLIENT_ID=${{ secrets.YANDEX_CLIENT_ID }}
        shell: pwsh
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: ğŸ“¦ Package Windows build
        run: |
          $releasePath = "build/windows/x64/runner/Release"
          if (-not (Test-Path $releasePath)) {
            Write-Error "âŒ Windows build not found at $releasePath"
            exit 1
          }
          Compress-Archive -Path "$releasePath/*" -DestinationPath windows-release.zip -Force
          Write-Host "âœ… Windows build packaged successfully"
        shell: pwsh

      # ========================================
      # ğŸ“¤ Upload Artifacts
      # ========================================
      - name: ğŸ“¤ Upload Android APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: app-*.apk
          retention-days: 30
          if-no-files-found: error

      - name: ğŸ“¤ Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: windows-release.zip
          retention-days: 30
          if-no-files-found: error

      # ========================================
      # ğŸ‰ Create GitHub Release
      # ========================================
      - name: ğŸ‰ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            app-*.apk
            windows-release.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # ğŸ“§ Notification
      # ========================================
      - name: ğŸ“§ Send notification on failure
        if: failure()
        run: |
          Write-Host "âŒ Build failed! Check the logs for details." -ForegroundColor Red
        shell: pwsh

      - name: ğŸŠ Build completed successfully
        if: success()
        run: Write-Host "âœ… Build and release completed successfully!" -ForegroundColor Green
        shell: pwsh

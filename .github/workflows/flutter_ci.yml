name: üöÄ Flutter CI/CD with Shorebird

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, dev, feature/* ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.6'
  JAVA_VERSION: '17'

jobs:
  # ========================================
  # üß™ Testing (for all branches)
  # ========================================
  test:
    name: üß™ Run Tests & Analysis
    runs-on: windows-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Set PUB_CACHE to project drive
        run: |
          $pubCachePath = "D:\pub-cache"
          New-Item -Path $pubCachePath -ItemType Directory -Force | Out-Null
          echo "PUB_CACHE=$pubCachePath" >> $env:GITHUB_ENV
          echo "$pubCachePath\bin" >> $env:GITHUB_PATH
          Write-Host "‚úÖ PUB_CACHE relocated to $pubCachePath"
        shell: pwsh

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üéØ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üì¶ Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            D:\pub-cache
            **/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: üìö Get Flutter dependencies
        run: flutter pub get

      - name: üîß Run code generation
        run: |
          dart run slang
          dart run build_runner build --delete-conflicting-outputs

      - name: üïµÔ∏è Static code analysis
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: ‚úÖ Run unit tests
        run: flutter test --coverage

  # ========================================
  # üèóÔ∏è Build & Release (only for main)
  # ========================================
  build:
    name: üèóÔ∏è Build & Release
    needs: test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Set PUB_CACHE to project drive
        run: |
          $pubCachePath = "D:\pub-cache"
          New-Item -Path $pubCachePath -ItemType Directory -Force | Out-Null
          echo "PUB_CACHE=$pubCachePath" >> $env:GITHUB_ENV
          echo "$pubCachePath\bin" >> $env:GITHUB_PATH
          Write-Host "‚úÖ PUB_CACHE relocated to $pubCachePath"
        shell: pwsh

      - name: üîß Enable Git Long Paths
        run: git config --system core.longpaths true
        shell: pwsh

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üéØ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üê¶ Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1

      - name: üîê Authenticate Shorebird
        run: |
          shorebird doctor
          if (-not (Test-Path "shorebird.yaml")) {
            Write-Error "shorebird.yaml not found! Initialize Shorebird locally first."
            exit 1
          }
        shell: pwsh
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: üì¶ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            D:\pub-cache
            **/.dart_tool
          key: ${{ runner.os }}-build-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: üìö Get dependencies
        run: flutter pub get

      - name: üîß Run code generation
        run: |
          dart run slang
          dart run build_runner build --delete-conflicting-outputs

      - name: üîë Decode Keystore
        run: |
          $base64String = "${{ secrets.KEYSTORE_BASE64 }}".Replace("`n","").Replace("`r","")
          $bytes = [System.Convert]::FromBase64String($base64String)
          $keystorePath = Join-Path $env:GITHUB_WORKSPACE "android/app/keystore.jks"
          [System.IO.File]::WriteAllBytes($keystorePath, $bytes)
          Write-Host "‚úÖ Keystore created at: $keystorePath"
        shell: pwsh

      - name: üìù Create key.properties
        run: |
          $keystorePath = Join-Path $env:GITHUB_WORKSPACE "android/app/keystore.jks"
          @"
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=$keystorePath
          "@ | Out-File -FilePath android/key.properties -Encoding utf8
          Write-Host "‚úÖ key.properties created with path: $keystorePath"
        shell: pwsh

      # ========================================
      # ü§ñ Android Build with Shorebird
      # ========================================
      - name: ü§ñ Build Android Release with Shorebird
        run: |
          shorebird release android `
            --flutter-version=${{ env.FLUTTER_VERSION }} `
            --artifact apk `
            -- `
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} `
            --dart-define=GOOGLE_CLIENT_ANDROID_ID=${{ secrets.GOOGLE_CLIENT_ANDROID_ID }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_SECRET=${{ secrets.GOOGLE_CLIENT_WINDOWS_SECRET }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_ID=${{ secrets.GOOGLE_CLIENT_WINDOWS_ID }} `
            --dart-define=YANDEX_CLIENT_ID=${{ secrets.YANDEX_CLIENT_ID }}
        shell: pwsh
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: üì¶ Copy Android artifacts
        run: |
          $apkFiles = Get-ChildItem -Path build/app/outputs/apk/release/*.apk -ErrorAction SilentlyContinue
          if (-not $apkFiles) {
            Write-Error "‚ùå No APK files found!"
            exit 1
          }
          foreach ($file in $apkFiles) {
            $newName = "app-" + $file.Name
            Copy-Item $file.FullName -Destination $newName
            Write-Host "‚úÖ Created: $newName"
          }
        shell: pwsh

      # ========================================
      # ü™ü Windows Build with Shorebird
      # ========================================
      - name: ü™ü Build Windows Release with Shorebird
        run: |
          shorebird release windows `
            --flutter-version=${{ env.FLUTTER_VERSION }} `
            -- `
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} `
            --dart-define=GOOGLE_CLIENT_ANDROID_ID=${{ secrets.GOOGLE_CLIENT_ANDROID_ID }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_SECRET=${{ secrets.GOOGLE_CLIENT_WINDOWS_SECRET }} `
            --dart-define=GOOGLE_CLIENT_WINDOWS_ID=${{ secrets.GOOGLE_CLIENT_WINDOWS_ID }} `
            --dart-define=YANDEX_CLIENT_ID=${{ secrets.YANDEX_CLIENT_ID }}
        shell: pwsh
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: üì¶ Package Windows build
        run: |
          $releasePath = "build/windows/x64/runner/Release"
          if (-not (Test-Path $releasePath)) {
            Write-Error "‚ùå Windows build not found at $releasePath"
            exit 1
          }
          Compress-Archive -Path "$releasePath/*" -DestinationPath windows-release.zip -Force
          Write-Host "‚úÖ Windows build packaged successfully"
        shell: pwsh

      # ========================================
      # üì§ Upload Artifacts
      # ========================================
      - name: üì§ Upload Android APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: app-*.apk
          retention-days: 30
          if-no-files-found: error

      - name: üì§ Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: windows-release.zip
          retention-days: 30
          if-no-files-found: error

      # ========================================
      # üéâ Create GitHub Release
      # ========================================
      - name: üéâ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            app-*.apk
            windows-release.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # üìß Notification
      # ========================================
      - name: üìß Send notification on failure
        if: failure()
        run: |
          Write-Host "‚ùå Build failed! Check the logs for details." -ForegroundColor Red
        shell: pwsh

      - name: üéä Build completed successfully
        if: success()
        run: Write-Host "‚úÖ Build and release completed successfully!" -ForegroundColor Green
        shell: pwsh
